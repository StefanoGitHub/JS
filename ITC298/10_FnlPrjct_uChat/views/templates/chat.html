<!-- templates -->
<script type="text/html" id="chatMessage-template">
    <li><span><%= username %></span> <%= msg %></li>
</script>

<script type="text/html" id="user-template">
    <% list.forEach(function(user) { %>
        <li> <%= user.username %> </li>
    <% }) %>
</script>
<!-- end templates -->



    <div id="chat">
        <div id="welcome">Welcome <span>{{username}}</span>! <br>
                You are now connected</div>

        <ul id="chat_messages">
            <!--loaded content from roomCollection-->
        </ul>

        <div id="chat_input_panel">
            <form id="chat-form" action="">
                <textarea id="msg_area" rows="3" placeholder="type your message" autofocus required></textarea>
                <button id="send" type="submit">Send</button>
            </form>
        </div>
    </div>
    <button id="logout">log out</button>

    <aside>
        <ul id="userList">
            <!--loaded content from messagesCollection-->
        </ul>
    </aside>



<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>

<script>
    //create client socket
    var socket = io('http://localhost:8000');
    //connect user
    socket.emit("userConnection", { username: '{{username}}', sessionID: '{{sessionID}}' });

    //whenever the user send a messages, generate the chat message event
    var $message_area = $('#msg_area');
    $('#chat-form').submit(function(){
        socket.emit('chatMessage', $message_area.val());
        $message_area.val('');
        return false;
    });

    //when receive a chatMessage display it
    socket.on('chatMessage', function(username, msg){
        console.log(username, msg);
        var template = _.template( $("#chatMessage-template").html() );
        var chatMessage = template({
            username: username,
            msg: msg
        });
        $('#chat_messages').append(chatMessage);
    });

    $('#logout').on('click', function(){
        socket.emit('logout');
        location.assign("/logout");
    });

    //when the list of connected users (roomCollection) changes, update the list
    socket.on('updateUsersList', function(room) {
        var template = _.template( $("#user-template").html() );
        var userList = template({ list: room });
        $('#userList').html(userList);
    });

</script>

